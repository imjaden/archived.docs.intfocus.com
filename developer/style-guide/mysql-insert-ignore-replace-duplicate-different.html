<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    
    <title>MySQL Insert 注意事项 — 胜因学院</title>
    <meta charset="utf-8">
    <meta name="description" content="Vue.js - The Progressive JavaScript Framework">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <meta property="og:type" content="article">
    <meta property="og:title" content="MySQL Insert 注意事项 — Vue.js">
    <meta property="og:description" content="Vue.js - The Progressive JavaScript Framework">
    <meta property="og:image" content="https://cn.vuejs.org//images/logo.png">

    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="MySQL Insert 注意事项 — Vue.js">
    <meta name="twitter:description" content="Vue.js - The Progressive JavaScript Framework">
    <meta name="twitter:image" content="https://cn.vuejs.org/images/logo.png">

    <link rel="icon" href="/images/intfocus.png" type="image/png">

    <meta name="msapplication-TileColor" content="#4fc08d">
    <meta name="theme-color" content="#4fc08d">

    <meta name="msapplication-config" content="browserconfig.xml">
    <link rel="manifest" href="/manifest.json">

    <link href="//code.bdstatic.com/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">

    
<link rel="stylesheet" href="/css/page.css">


    <script src="/js/vue.js"></script>
    <script>
      Vue.config.productionTip = false;
      window.PAGE_TYPE = "MySQL Insert 注意事项";
    </script>
  <meta name="generator" content="Hexo 6.3.0"></head>
  
  <body class="docs">
    <div id="mobile-bar" >
      <a class="menu-button"></a>
      <a class="logo" href="/"></a>
    </div>
    <div id="header">
  <a id="logo" href="/">
    <img src="/images/logo.png" alt="vue logo">
    <span>Intfocus</span>
  </a>
  <ul id="nav">
    <li>
  <form id="search-form">
    <input type="text" id="search-query-nav" class="search-query st-default-search-input">
  </form>
</li>
<li class="nav-dropdown-container learn">
  <a class="nav-link current">生态系统</a><span class="arrow"></span>
  <ul class="nav-dropdown">
    <li><h4>应用实例</h4></li>
    <li>
      <ul>
        <li><a href="/application/syp-wxmp.html" class="nav-link">胜因学院<small>(小程序)</small></a></li>
        <li><a href="/application/syp-android-tv.html" class="nav-link">胜因盒子<small>(TV大屏)</small></a></li>
      </ul>
    </li>
  </ul>
</li>

<li class="nav-dropdown-container learn">
  <a class="nav-link current">开发文档</a><span class="arrow"></span>
  <ul class="nav-dropdown">
    <li><a href="/developer/guide.html" class="nav-link current">规范指南</a></li>
    <li><h4>编程规范</h4></li>
    <li>
      <ul>
        <li><a href="/developer/style-guide/gitlab.html" class="nav-link">Gitlab</a></li>
        <li><a href="/developer/style-guide/java.html" class="nav-link">Java</a></li>
        <li><a href="/developer/style-guide/mysql.html" class="nav-link current">MySQL</a></li>
        <li><a href="/developer/style-guide/javascript.html" class="nav-link">Javascript</a></li>
        <li><a href="/developer/style-guide/cdn.html" class="nav-link">CDN 运维</a></li>
      </ul>
    </li>
    <li><h4>开发规范</h4></li>
    <li>
      <ul>
        <li><a href="/developer/environment-guide.html" class="nav-link">环境规范<small></small></a></li>
        <li><a href="/developer/etl-devops-guide.html" class="nav-link">ETL 运维<small></small></a></li>
        <li><a href="/developer/api-design-guide.html" class="nav-link">API 设计<small></small></a></li>
        <li><a href="/developer/rdc-guide.html" class="nav-link">RDC 接口<small></small></a></li>
        <li><a href="/developer/menu-guide.html" class="nav-link">业务菜单<small></small></a></li>
      </ul>
    </li>
    <li><h4>接口文档</h4></li>
    <li>
      <ul>
        <li><a href="/developer/api-guide/syp-wxmp.html" class="nav-link">胜因学院<small>(小程序)</small></a></li>
        <li><a href="/developer/api-guide/datav-report.html" class="nav-link">DataV报表<small>(大屏)</small></a></li>
        <li><a href="/developer/api-guide/java-admin-add-module.html" class="nav-link">添加模块<small>(运营平台)</small></a></li>
      </ul>
    </li>
    <li><h4>项目源码</h4></li>
    <li>
      <ul>
        <li><a href="/developer/project-connections.html" class="nav-link">源码体系</a></li>
        <li><a href="/developer/sypctl-readme.html" class="nav-link">SypCtl 工具</a></li>
        <li><a href="/developer/jenkins-deploy.html" class="nav-link">Jenkins 部署</a></li>
      </ul>
    </li>
  </ul>
</li>

<li class="nav-dropdown-container learn">
  <a class="nav-link current">企业文化</a><span class="arrow"></span>
  <ul class="nav-dropdown">
    <li><h4>职场培训</h4></li>
    <li>
      <ul>
        <li><a href="/corporate-culture/workplace-ceremony.html" class="nav-link">职场共识</a></li>
        <li><a href="/corporate-culture/teamwork.html" class="nav-link">职场协作</a></li>
      </ul>
    </li>
    <li><h4>生命力</h4></li>
    <li>
      <ul>
        <li><a href="/corporate-culture/online-documents.html" class="nav-link">在线文档</a></li>
        <li><a href="/corporate-culture/weekly-publication.html" class="nav-link">胜因周刊</a></li>
      </ul>
    </li>
  </ul>
</li>


<li class="nav-dropdown-container learn">
  <a class="nav-link current">外链导航</a><span class="arrow"></span>
  <ul class="nav-dropdown">
    <li>
    <a href="https://www.intfocus.com" target="_blank" class="nav-link team">胜因官网</a>
    </li>
    <li>
    <a target="_blank" rel="noopener" href="//jaden.tech/resume?t=1686451604220" class="nav-link team">我的简历</a>
    </li>
  </ul>
</li>

  </ul>
</div>

    
    

    
      <div id="main" class="fix-sidebar">
        
          
  <div class="sidebar">
  <div class="sidebar-inner">
    <ul class="main-menu">
      <li>
  <form id="search-form">
    <input type="text" id="search-query-sidebar" class="search-query st-default-search-input">
  </form>
</li>
<li class="nav-dropdown-container learn">
  <a class="nav-link current">生态系统</a><span class="arrow"></span>
  <ul class="nav-dropdown">
    <li><h4>应用实例</h4></li>
    <li>
      <ul>
        <li><a href="/application/syp-wxmp.html" class="nav-link">胜因学院<small>(小程序)</small></a></li>
        <li><a href="/application/syp-android-tv.html" class="nav-link">胜因盒子<small>(TV大屏)</small></a></li>
      </ul>
    </li>
  </ul>
</li>

<li class="nav-dropdown-container learn">
  <a class="nav-link current">开发文档</a><span class="arrow"></span>
  <ul class="nav-dropdown">
    <li><a href="/developer/guide.html" class="nav-link current">规范指南</a></li>
    <li><h4>编程规范</h4></li>
    <li>
      <ul>
        <li><a href="/developer/style-guide/gitlab.html" class="nav-link">Gitlab</a></li>
        <li><a href="/developer/style-guide/java.html" class="nav-link">Java</a></li>
        <li><a href="/developer/style-guide/mysql.html" class="nav-link current">MySQL</a></li>
        <li><a href="/developer/style-guide/javascript.html" class="nav-link">Javascript</a></li>
        <li><a href="/developer/style-guide/cdn.html" class="nav-link">CDN 运维</a></li>
      </ul>
    </li>
    <li><h4>开发规范</h4></li>
    <li>
      <ul>
        <li><a href="/developer/environment-guide.html" class="nav-link">环境规范<small></small></a></li>
        <li><a href="/developer/etl-devops-guide.html" class="nav-link">ETL 运维<small></small></a></li>
        <li><a href="/developer/api-design-guide.html" class="nav-link">API 设计<small></small></a></li>
        <li><a href="/developer/rdc-guide.html" class="nav-link">RDC 接口<small></small></a></li>
        <li><a href="/developer/menu-guide.html" class="nav-link">业务菜单<small></small></a></li>
      </ul>
    </li>
    <li><h4>接口文档</h4></li>
    <li>
      <ul>
        <li><a href="/developer/api-guide/syp-wxmp.html" class="nav-link">胜因学院<small>(小程序)</small></a></li>
        <li><a href="/developer/api-guide/datav-report.html" class="nav-link">DataV报表<small>(大屏)</small></a></li>
        <li><a href="/developer/api-guide/java-admin-add-module.html" class="nav-link">添加模块<small>(运营平台)</small></a></li>
      </ul>
    </li>
    <li><h4>项目源码</h4></li>
    <li>
      <ul>
        <li><a href="/developer/project-connections.html" class="nav-link">源码体系</a></li>
        <li><a href="/developer/sypctl-readme.html" class="nav-link">SypCtl 工具</a></li>
        <li><a href="/developer/jenkins-deploy.html" class="nav-link">Jenkins 部署</a></li>
      </ul>
    </li>
  </ul>
</li>

<li class="nav-dropdown-container learn">
  <a class="nav-link current">企业文化</a><span class="arrow"></span>
  <ul class="nav-dropdown">
    <li><h4>职场培训</h4></li>
    <li>
      <ul>
        <li><a href="/corporate-culture/workplace-ceremony.html" class="nav-link">职场共识</a></li>
        <li><a href="/corporate-culture/teamwork.html" class="nav-link">职场协作</a></li>
      </ul>
    </li>
    <li><h4>生命力</h4></li>
    <li>
      <ul>
        <li><a href="/corporate-culture/online-documents.html" class="nav-link">在线文档</a></li>
        <li><a href="/corporate-culture/weekly-publication.html" class="nav-link">胜因周刊</a></li>
      </ul>
    </li>
  </ul>
</li>


<li class="nav-dropdown-container learn">
  <a class="nav-link current">外链导航</a><span class="arrow"></span>
  <ul class="nav-dropdown">
    <li>
    <a href="https://www.intfocus.com" target="_blank" class="nav-link team">胜因官网</a>
    </li>
    <li>
    <a target="_blank" rel="noopener" href="//jaden.tech/resume?t=1686451604220" class="nav-link team">我的简历</a>
    </li>
  </ul>
</li>

    </ul>
    <div class="list">
      
      
        <h2>
          
          
          
        </h2>
        <ul class="menu-root">
  
    
    
    <li>
      <a href="/developer/style-guide/mysql-insert-ignore-replace-duplicate-different.html" class="sidebar-link current">MySQL Insert 注意事项</a>
    </li>
  
</ul>

      
    </div>
  </div>
</div>

<!--
<div id="sidebar-sponsors-platinum-right">
  <div class="main-sponsor">
    <span>白金赞助商</span>
    <div>
    <a href="https://bit.dev/?utm_source=vue&utm_medium=vue&utm_campaign=vue&utm_term=vue&utm_content=vue" target="_blank" class="logo">
      <img src="/images/bit.png" alt="Bit">
    </a>
    <a href="http://tooltwist.com/" target="_blank" class="logo">
      <img src="/images/tooltwist.png" alt="Tooltwist">
    </a>
    <a href="https://vueschool.io/?utm_source=Vuejs.org&utm_medium=Banner&utm_campaign=Sponsored%20Banner&utm_content=V1" target="_blank" class="logo">
      <img src="/images/vueschool.png" alt="VueSchool">
    </a>
    <a href="https://vehikl.com/" target="_blank" class="logo">
      <img src="/images/vehikl.png" alt="Vehikl">
    </a>
    <a href="https://www.nativescript.org/vue?utm_source=vue-js-org&utm_medium=website&utm_campaign=nativescript-awareness" target="_blank" class="logo">
      <img src="/images/nativescript.png" alt="NativeScript">
    </a>
    <a href="https://teeplusplusclth.com/" target="_blank" class="logo">
      <img src="/images/tee__.png" alt="Tee++">
    </a>
    </div>
  </div>
  <a class="become-backer" href="/support-vuejs">
    成为赞助者
  </a>
</div>

-->


<div class="content MySQL Insert 注意事项 with-sidebar ">
  
    
      
    
  
  
    <h1>MySQL Insert 注意事项</h1>
  

  

  
    <h2 id="Create-Table"><a href="#Create-Table" class="headerlink" title="Create Table"></a>Create Table</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">create table if not exists `tbl_insert_ignore_replace_duplicate` (<br>  `id` int(11) not null auto_increment comment &#x27;自增主键&#x27;,<br>  `label` varchar(20) not null comment &#x27;唯一标识&#x27;,<br>  `data_update_time` timestamp not null default current_timestamp comment &#x27;数据更新时间&#x27;,<br>  primary key (`id`),<br>  unique index `inx_label` (`label`)<br>) engine=innodb default charset=utf8 row_format=dynamic comment=&#x27;测试insert/ignore/replace/duplicate功能&#x27;;<br></code></pre></td></tr></table></figure>

<h2 id="Insert-Into"><a href="#Insert-Into" class="headerlink" title="Insert Into"></a>Insert Into</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">mysql &gt; insert into tbl_insert_ignore_replace_duplicate(label) value (&#x27;insert&#x27;), (&#x27;replace&#x27;), (&#x27;duplicate&#x27;);<br><br>Query OK, 3 rows affected (0.01 sec)<br>Records: 3  Duplicates: 0  Warnings: 0<br><br>mysql&gt; select * from tbl_insert_ignore_replace_duplicate;<br>+----+-----------+---------------------+<br>| id | label     | data_update_time    |<br>+----+-----------+---------------------+<br>|  1 | insert    | 2019-10-16 23:22:21 |<br>|  2 | replace   | 2019-10-16 23:22:21 |<br>|  3 | duplicate | 2019-10-16 23:22:21 |<br>+----+-----------+---------------------+<br></code></pre></td></tr></table></figure>

<p>普通 <code>insert into</code> 当主键或唯一索引冲突时，MySQL 会异常报错中断执行。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">mysql&gt; mysql &gt; insert into tbl_insert_ignore_replace_duplicate(label) value (&#x27;insert&#x27;);<br>ERROR 1062 (23000): Duplicate entry &#x27;insert&#x27; for key &#x27;inx_label&#x27;<br><br>mysql&gt; show create table tbl_insert_ignore_replace_duplicate;<br><br>CREATE TABLE `tbl_insert_ignore_replace_duplicate` (<br>  `id` int(11) NOT NULL AUTO_INCREMENT COMMENT &#x27;自增主键&#x27;,<br>  `label` varchar(20) NOT NULL COMMENT &#x27;唯一标识&#x27;,<br>  `data_update_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#x27;数据更新时间&#x27;,<br>  PRIMARY KEY (`id`),<br>  UNIQUE KEY `inx_label` (`label`)<br>) ENGINE=InnoDB AUTO_INCREMENT=5 DEFAULT CHARSET=utf8 ROW_FORMAT=DYNAMIC COMMENT=&#x27;测试insert/ignore/replace/duplicate功能&#x27;<br></code></pre></td></tr></table></figure>

<p>虽然插入失败，但占用了一次 id+1 机会，即把 id&#x3D;4 使用了，下次 id 从 5 开始。</p>
<p><em>TODO: 待确认 master-slave 集群时，slave 库中表的 <code>AUTO_INCREMENT</code> 值与 master 相同</em></p>
<h2 id="Replace-Into-禁用"><a href="#Replace-Into-禁用" class="headerlink" title="Replace Into (禁用)"></a>Replace Into (禁用)</h2><p><code>replace into</code> 操作时，当主键或唯一索引冲突时就是普通的 <code>insert into</code> 效果。</p>
<p><strong>但是</strong>，当有主键或唯一索引冲突时，会删除冲突行，重新插入，从而 <code>id</code> 自动 <code>+1</code>.</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">mysql&gt; select version();<br>+-----------+<br>| version() |<br>+-----------+<br>| 5.7.25    |<br>+-----------+<br>1 row in set (0.01 sec)<br><br>mysql&gt; select * from tbl_insert_ignore_replace_duplicate;<br>+----+-----------+---------------------+<br>| id | label     | data_update_time    |<br>+----+-----------+---------------------+<br>|  1 | insert    | 2019-10-16 23:22:21 |<br>|  2 | replace   | 2019-10-16 23:22:21 |<br>|  3 | duplicate | 2019-10-16 23:22:21 |<br>+----+-----------+---------------------+<br>3 rows in set (0.00 sec)<br><br>mysql&gt; replace into tbl_insert_ignore_replace_duplicate(label) value (&#x27;replace&#x27;);<br>Query OK, 2 rows affected (0.00 sec)<br><br># 上面 insert into 冲突时，造成了 id=(旧id最大值+1)=4<br>mysql&gt; select * from tbl_insert_ignore_replace_duplicate;<br>+----+-----------+---------------------+<br>| id | label     | data_update_time    |<br>+----+-----------+---------------------+<br>|  1 | insert    | 2019-10-16 23:22:21 |<br>|  3 | duplicate | 2019-10-16 23:22:21 |<br>|  5 | replace   | 2019-10-16 23:27:50 |<br>+----+-----------+---------------------+<br>3 rows in set (0.00 sec)<br><br>mysql&gt; replace into tbl_insert_ignore_replace_duplicate(label) value (&#x27;replace&#x27;);<br>Query OK, 2 rows affected (0.00 sec)<br><br>mysql&gt; select * from tbl_insert_ignore_replace_duplicate;<br>+----+-----------+---------------------+<br>| id | label     | data_update_time    |<br>+----+-----------+---------------------+<br>|  1 | insert    | 2019-10-16 23:22:21 |<br>|  3 | duplicate | 2019-10-16 23:22:21 |<br>|  6 | replace   | 2019-10-16 23:28:35 |<br>+----+-----------+---------------------+<br>3 rows in set (0.00 sec)<br><br>mysql&gt; show create table tbl_insert_ignore_replace_duplicate;<br><br>CREATE TABLE `tbl_insert_ignore_replace_duplicate` (<br>  `id` int(11) NOT NULL AUTO_INCREMENT COMMENT &#x27;自增主键&#x27;,<br>  `label` varchar(20) NOT NULL COMMENT &#x27;唯一标识&#x27;,<br>  `data_update_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#x27;数据更新时间&#x27;,<br>  PRIMARY KEY (`id`),<br>  UNIQUE KEY `inx_label` (`label`)<br>) ENGINE=InnoDB AUTO_INCREMENT=7 DEFAULT CHARSET=utf8 ROW_FORMAT=DYNAMIC COMMENT=&#x27;测试insert/ignore/replace/duplicate功能&#x27;<br></code></pre></td></tr></table></figure>

<p>若配置了主从同步，则此时 slave 库中 tbl_insert_ignore_replace_duplicate 表的 AUTO_INCREMENT &#x3D; 4。</p>
<p>当 master 库压力过大或其他情况，需要把 slave 库转为 master 库时，造成 id 在 4-6 区间的数据无法同步到旧 master 库(出现 duplicate key error)</p>
<p><em>TODO: 待实践确认</em></p>
<h2 id="Insert-Ignore-Into"><a href="#Insert-Ignore-Into" class="headerlink" title="Insert Ignore Into"></a>Insert Ignore Into</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">mysql&gt; insert ignore into tbl_insert_ignore_replace_duplicate(label) value (&#x27;insert&#x27;);<br>Query OK, 0 rows affected, 1 warning (0.00 sec)<br><br># 无任何<br>mysql&gt; select * from tbl_insert_ignore_replace_duplicate;<br>+----+-----------+---------------------+<br>| id | label     | data_update_time    |<br>+----+-----------+---------------------+<br>|  1 | insert    | 2019-10-16 23:22:21 |<br>|  3 | duplicate | 2019-10-16 23:22:21 |<br>|  6 | replace   | 2019-10-16 23:28:35 |<br>+----+-----------+---------------------+<br>4 rows in set (0.00 sec)<br><br># AUTO_INCREMENT 还是 +1 了！<br>mysql&gt; show create table tbl_insert_ignore_replace_duplicate;<br><br>CREATE TABLE `tbl_insert_ignore_replace_duplicate` (<br>  `id` int(11) NOT NULL AUTO_INCREMENT COMMENT &#x27;自增主键&#x27;,<br>  `label` varchar(20) NOT NULL COMMENT &#x27;唯一标识&#x27;,<br>  `data_update_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#x27;数据更新时间&#x27;,<br>  PRIMARY KEY (`id`),<br>  UNIQUE KEY `inx_label` (`label`)<br>) ENGINE=InnoDB AUTO_INCREMENT=8 DEFAULT CHARSET=utf8 ROW_FORMAT=DYNAMIC COMMENT=&#x27;测试insert/ignore/replace/duplicate功能&#x27;<br></code></pre></td></tr></table></figure>

<h2 id="On-Duplicate-Key-Update"><a href="#On-Duplicate-Key-Update" class="headerlink" title="On Duplicate Key Update"></a>On Duplicate Key Update</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">mysql&gt; insert into tbl_insert_ignore_replace_duplicate(label) value (&#x27;duplicate&#x27;) on duplicate key update data_update_time = now();<br>Query OK, 2 rows affected (0.01 sec)<br><br># label = duplicate 行更新了 data_update_time 列<br>mysql&gt; select * from tbl_insert_ignore_replace_duplicate;<br>+----+-----------+---------------------+<br>| id | label     | data_update_time    |<br>+----+-----------+---------------------+<br>|  1 | insert    | 2019-10-16 23:22:21 |<br>|  3 | duplicate | 2019-10-16 23:38:33 |<br>|  6 | replace   | 2019-10-16 23:28:35 |<br>+----+-----------+---------------------+<br>4 rows in set (0.00 sec)<br></code></pre></td></tr></table></figure>

  
  
  
</div>

        
      </div>
      <script src="/js/smooth-scroll.min.js"></script>
    

    <script src="/js/css.escape.js"></script>
    <script src="/js/common.js"></script>

    <link href="//code.bdstatic.com/npm/docsearch.js@1.5.0/dist/cdn/docsearch.min.css" rel='stylesheet' type='text/css'>
    
<link rel="stylesheet" href="/css/search.css">

    <script src="//code.bdstatic.com/npm/docsearch.js@1.5.0/dist/cdn/docsearch.min.js"></script>
    <script>
    [
      '#search-query-nav',
      '#search-query-sidebar',
      '#search-query-menu'
    ].forEach(function (selector) {
      if (!document.querySelector(selector)) return
      // search index defaults to v2
      var match = window.location.pathname.match(/^\/(v\d+)/)
      var version = match ? match[1] : 'v2'
      docsearch({
      appId: 'BH4D9OD16A',
      apiKey: '5638280abff9d207417bb03be05f0b25',
      indexName: 'vuejs_cn2',
      inputSelector: selector,
      algoliaOptions: { facetFilters: ["version:" + version] },
      autocompleteOptions: { hint: false, appendTo: 'body'}
      })
    })
    </script>

    <!-- fastclick -->
    <script src="//code.bdstatic.com/npm/fastclick@1.0.6/lib/fastclick.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
      FastClick.attach(document.body)
    }, false)
    </script>
  </body>
</html>
